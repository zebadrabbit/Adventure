{% extends 'dashboard_base.html' %}
{% from 'macros/svg_icon.html' import svg_icon %}
{% from 'macros/seed_widget.html' import seed_widget %}

{% block dashboard_content %}

<div id="lobby-chat-widget" class="mud-chat-widget">
    <div class="mud-chat-tabs-row d-flex align-items-center justify-content-between chat-header">
        <ul class="nav nav-tabs flex-grow-1 mb-0" id="chatTabNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-general" data-bs-toggle="tab" data-bs-target="#chat-general" type="button" role="tab" aria-controls="chat-general" aria-selected="true">General</button>
            </li>
            <!-- Dynamic tabs will be inserted here -->
        </ul>
        <button id="lobby-chat-toggle-btn" class="btn btn-sm btn-outline-secondary ms-2 btn-square-32" title="Expand/Collapse Chat">
            <i class="bi bi-chevron-up" id="lobby-chat-chevron"></i>
        </button>
    </div>
    <div class="mud-chat-body d-flex flex-column chat-body-240">
        <div class="tab-content flex-grow-1 d-flex flex-column" id="chatTabContent">
            <div class="tab-pane fade show active d-flex flex-column h-100" id="chat-general" role="tabpanel" aria-labelledby="tab-general">
                <div class="chat-messages flex-grow-1" id="lobby-chat-messages-general"></div>
                <form class="chat-form mt-2" id="lobby-chat-form-general" autocomplete="off">
                    <input type="text" id="lobby-chat-input-general" class="form-control" placeholder="Type a message..." maxlength="200" required />
                    <button type="submit" id="lobby-chat-send-general" class="btn btn-primary"><i class="bi bi-send"></i></button>
                </form>
            </div>
            <!-- Dynamic tab panes will be inserted here -->
        </div>
    </div>
</div>

<div class="row mb-4 align-items-start">
    <!-- Character creation card -->
    <div class="col-md-6 col-lg-4 d-flex flex-column">
        <div class="card h-100 shadow-sm border-success">
            <div class="card-header bg-success text-white">
                <i class="bi bi-plus-circle me-2"></i>Create a Character
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-2">
                            <label for="name" class="form-label">Name</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="name" name="name" placeholder="Your hero's name" required aria-label="Character name" aria-describedby="randomize-name">
                                <button class="btn btn-outline-secondary" type="button" id="randomize-name" title="Randomize name">
                                    <i class="bi bi-dice-5"></i>
                                </button>
                            </div>
                    </div>
                    <div class="mb-2">
                        <label for="char_class" class="form-label">Class</label>
                        <select class="form-select" id="char_class" name="char_class" required>
                            <option value="fighter">Fighter</option>
                            <option value="rogue">Rogue</option>
                            <option value="mage">Mage</option>
                            <option value="cleric">Cleric</option>
                            <option value="ranger">Ranger</option>
                            <option value="druid">Druid</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Create Character</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-8">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-warning">
                <strong><i class="bi bi-people-fill me-2"></i>Your Party</strong>
                <span class="float-end"><span id="party-count">0</span> / 4 selected</span>
            </div>
            <div class="card-body">
                                <div id="party-blurb" class="small text-light fst-italic mb-2">
                                    Choose your party for the next adventure. Only the bravest will answer the call!
                                </div>
                <div id="party-table" class="mt-2"></div>
                <form method="POST" id="begin-adventure-form" class="mt-3 d-flex flex-column gap-2">
                    <input type="hidden" name="form" value="start_adventure">
                    <div id="party-hidden-inputs"></div>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" id="autofill-party-btn" class="btn btn-outline-secondary me-2" title="Autofill party with random characters">
                            <i class="bi bi-shuffle"></i> Autofill
                        </button>
                        <button type="submit" id="begin-adventure-btn" class="btn btn-warning" disabled>
                            {{ svg_icon('dungeon-gate', 20, 'me-1 align-text-bottom') }} Begin Adventure
                        </button>
                        {{ seed_widget(dungeon_seed) }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<div class="row g-4">
    {% for c in characters %}
    <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-default character-card" data-id="{{ c.id }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="d-flex align-items-center">
                                    {% set class_lower = c.class_name.lower() %}
                                    <span class="me-2 icon-28 u-flex-center">
                                        {% if class_lower == 'fighter' %}
                                            {{ svg_icon('swords-power', 24, 'icon-glow') }}
                                        {% elif class_lower == 'mage' %}
                                            {{ svg_icon('fire-silhouette', 24, 'icon-glow') }}
                                        {% elif class_lower == 'rogue' %}
                                            {{ svg_icon('rogue', 24, 'icon-glow') }}
                                        {% elif class_lower == 'druid' %}
                                            {{ svg_icon('heavy-thorny-triskelion', 24, 'icon-glow') }}
                                        {% elif class_lower == 'cleric' %}
                                            {{ svg_icon('aura', 24, 'icon-glow') }}
                                        {% elif class_lower == 'ranger' %}
                                            {{ svg_icon('bowman', 24, 'icon-glow') }}
                                        {% else %}
                                            <i class="bi bi-person-fill"></i>
                                        {% endif %}
                                    </span>
                                    <span>{{ c.name }}</span>
                                </span>
                                <div class="d-flex align-items-center gap-2">
                                        <span class="badge class-badge {{ c.class_name|lower }}-badge">{{ c.class_name }}</span>
                                        <span class="badge bg-info">Lvl {{ c.level }}</span>
                                        <div class="form-check m-0">
                                                <input class="form-check-input party-select" type="checkbox"
                                                             value="{{ c.id }}"
                                                             id="party-{{ c.id }}"
                                                             data-id="{{ c.id }}"
                                                             data-name="{{ c.name }}"
                                                             data-class="{{ c.class_name }}">
                                                <label class="form-check-label small" for="party-{{ c.id }}">Select</label>
                                        </div>
                                </div>
                        </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="text-warning">XP:</span>
                    <span class="text-light">{{ c.xp }} / {{ c.xp_next }} (to level {{ c.level + 1 }})</span>
                </div>
                <div class="mb-2">
                    <h6 class="text-uppercase text-muted">Stats</h6>
                    <div class="container-fluid px-0">
                        <div class="row row-cols-2 g-1 small">
                            <div class="col"><span class="fw-bold">STR</span>: {{ c.stats.str }}</div>
                            <div class="col"><span class="fw-bold">DEX</span>: {{ c.stats.dex }}</div>
                            <div class="col"><span class="fw-bold">INT</span>: {{ c.stats.int }}</div>
                            <div class="col"><span class="fw-bold">WIS</span>: {{ c.stats.wis }}</div>
                            <div class="col"><span class="fw-bold">CHA</span>: {{ c.stats.cha }}</div>
                            <div class="col"><span class="fw-bold">CON</span>: {{ c.stats.con }}</div>
                            <div class="col"><span class="fw-bold">HP</span>: {{ c.stats.hp }}</div>
                            <div class="col"><span class="fw-bold">Mana</span>: {{ c.stats.mana }}</div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                    <span title="Gold" class="coin-gold">{{ svg_icon('cash', 18, 'me-1 coin-gold') }} {{ c.coins.gold }}</span>
                    <span title="Silver" class="coin-silver">{{ svg_icon('two-coins', 18, 'me-1 coin-silver') }} {{ c.coins.silver }}</span>
                    <span title="Copper" class="coin-copper">{{ svg_icon('token', 18, 'me-1 coin-copper') }} {{ c.coins.copper }}</span>
                </div>
                <!-- Make sure FontAwesome is loaded in your base template -->
                <h6 class="text-uppercase text-muted">{{ svg_icon('knapsack', 18, 'me-1 align-text-bottom') }} Inventory</h6>
                {% if c.inventory and c.inventory|length > 0 %}
                    <ul class="small mb-0 list-reset">
                        {% for it in c.inventory %}
                            <li>
                                {% if it.type == 'weapon' %}
                                    {{ svg_icon('bloody-sword', 18, 'me-1') }}
                                {% elif it.type == 'armor' %}
                                    {{ svg_icon('shield', 18, 'me-1') }}
                                {% elif it.type == 'potion' %}
                                    {{ svg_icon('potion-ball', 18, 'me-1') }}
                                {% elif it.type == 'tool' %}
                                    {{ svg_icon('anvil', 18, 'me-1') }}
                                {% elif it.type == 'ring' %}
                                    {{ svg_icon('ring', 18, 'me-1') }}
                                {% elif it.type == 'scroll' %}
                                    {{ svg_icon('scroll-unfurled', 18, 'me-1') }}
                                {% else %}
                                    {{ svg_icon('chest', 18, 'me-1') }}
                                {% endif %}
                                {{ it.name }} <span class="text-muted">({{ it.type }})</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-muted small">No items</div>
                {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-between">
                <form action="{{ url_for('dashboard.delete_character', char_id=c.id) }}" method="post" onsubmit="return confirm('Delete {{ c.name }}?');">
                    <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Delete</button>
                </form>
                <a href="#" class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-gear"></i> Manage</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="{{ asset_url('dashboard.css') }}">
    <link rel="stylesheet" href="{{ asset_url('class-badges.css') }}">
    <!-- Socket.IO client 5.x to match python-socketio 5 (Flask-SocketIO 5.3.7) -->
    <script src="https://cdn.socket.io/5.4.1/socket.io.min.js" integrity="sha384-placeholder" crossorigin="anonymous"></script>
    <script src="{{ asset_url('chat-widget.js') }}"></script>
    <script src="{{ asset_url('dashboard.js') }}"></script>
    <script src="{{ asset_url('js/seed-widget.js') }}"></script>
{% endblock %}
